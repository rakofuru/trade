name: deploy-vps
# Secrets contract:
# - VPS_USER must be an SSH key-auth deploy user with passwordless sudo for /bin/systemctl and /bin/journalctl
# - VPS_FINGERPRINT is required for host key pinning

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_ref:
        description: "Branch, tag, or commit SHA to deploy (default: current SHA)"
        required: false
        default: ""

concurrency:
  group: deploy-vps
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Secret guard (.env.local)
        shell: bash
        run: |
          set -euo pipefail
          if git ls-files --error-unmatch .env.local >/dev/null 2>&1; then
            echo "::error::.env.local is tracked. Run: git rm --cached .env.local"
            exit 1
          fi
          test -f .env.local.example

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: CI validation (test + selftest)
        shell: bash
        run: |
          set -euo pipefail
          npm ci
          npm run test
          npm run selftest

      - name: Resolve deploy ref
        id: ref
        shell: bash
        run: |
          set -euo pipefail
          ref="${{ github.event.inputs.deploy_ref }}"
          if [[ -z "${ref}" ]]; then
            ref="${GITHUB_SHA}"
          fi
          echo "ref=${ref}" >> "${GITHUB_OUTPUT}"
          echo "Deploy ref: ${ref}"

      - name: Validate SSH deploy secrets
        id: ssh_inputs
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_FINGERPRINT: ${{ secrets.VPS_FINGERPRINT }}
        run: |
          set -euo pipefail
          missing=()
          [[ -n "${VPS_HOST:-}" ]] || missing+=("VPS_HOST")
          [[ -n "${VPS_PORT:-}" ]] || missing+=("VPS_PORT")
          [[ -n "${VPS_USER:-}" ]] || missing+=("VPS_USER")
          [[ -n "${VPS_SSH_KEY:-}" ]] || missing+=("VPS_SSH_KEY")
          [[ -n "${VPS_FINGERPRINT:-}" ]] || missing+=("VPS_FINGERPRINT")
          if ((${#missing[@]} > 0)); then
            echo "::error::Missing required GitHub Secrets: ${missing[*]}"
            exit 1
          fi

          host="$(printf '%s' "${VPS_HOST}" | tr -d '\r' | xargs)"
          port="$(printf '%s' "${VPS_PORT}" | tr -d '\r' | xargs)"
          user="$(printf '%s' "${VPS_USER}" | tr -d '\r' | xargs)"
          fp_raw="$(printf '%s' "${VPS_FINGERPRINT}" | tr -d '\r')"
          fp_trimmed="$(printf '%s' "${fp_raw}" | xargs)"
          fp=""

          if [[ "${fp_trimmed}" == ssh-* ]]; then
            tmp_key="$(mktemp)"
            printf '%s\n' "${fp_trimmed}" > "${tmp_key}"
            fp="$(ssh-keygen -lf "${tmp_key}" -E sha256 | awk '{print $2}')"
            rm -f "${tmp_key}"
          else
            fp="$(printf '%s\n' "${fp_trimmed}" | grep -oE 'SHA256:[A-Za-z0-9+/=]+' | head -n1)"
          fi

          if [[ -z "${fp}" ]]; then
            echo "::error::VPS_FINGERPRINT must contain SHA256:<base64> or a full SSH public key line."
            exit 1
          fi

          echo "host=${host}" >> "${GITHUB_OUTPUT}"
          echo "port=${port}" >> "${GITHUB_OUTPUT}"
          echo "user=${user}" >> "${GITHUB_OUTPUT}"
          echo "fingerprint=${fp}" >> "${GITHUB_OUTPUT}"

      - name: Preflight host key fingerprint
        shell: bash
        env:
          VPS_HOST: ${{ steps.ssh_inputs.outputs.host }}
          VPS_PORT: ${{ steps.ssh_inputs.outputs.port }}
          VPS_FINGERPRINT: ${{ steps.ssh_inputs.outputs.fingerprint }}
        run: |
          set -euo pipefail
          hostkeys="$(mktemp)"
          trap 'rm -f "${hostkeys}"' EXIT

          ssh-keyscan -p "${VPS_PORT}" -t ed25519,ecdsa,rsa "${VPS_HOST}" > "${hostkeys}" 2>/dev/null || true
          if [[ ! -s "${hostkeys}" ]]; then
            echo "::error::Unable to fetch SSH host keys via ssh-keyscan for ${VPS_HOST}:${VPS_PORT}"
            exit 1
          fi

          fingerprints="$(ssh-keygen -lf "${hostkeys}" -E sha256 | awk '{print $2}' | sort -u)"
          if ! printf '%s\n' "${fingerprints}" | grep -Fxq "${VPS_FINGERPRINT}"; then
            echo "::error::VPS_FINGERPRINT does not match host keys for ${VPS_HOST}:${VPS_PORT}"
            echo "Discovered fingerprints:"
            printf '%s\n' "${fingerprints}"
            exit 1
          fi

      - name: Prepare SSH client
        shell: bash
        env:
          VPS_HOST: ${{ steps.ssh_inputs.outputs.host }}
          VPS_PORT: ${{ steps.ssh_inputs.outputs.port }}
          VPS_USER: ${{ steps.ssh_inputs.outputs.user }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          set -euo pipefail
          install -m 700 -d ~/.ssh
          key_file="${HOME}/.ssh/hlauto_deploy_key"
          printf '%s\n' "${VPS_SSH_KEY}" > "${key_file}"
          chmod 600 "${key_file}"
          ssh-keyscan -p "${VPS_PORT}" -t ed25519,ecdsa,rsa "${VPS_HOST}" > "${HOME}/.ssh/known_hosts" 2>/dev/null
          if [[ ! -s "${HOME}/.ssh/known_hosts" ]]; then
            echo "::error::Failed to build known_hosts for ${VPS_HOST}:${VPS_PORT}"
            exit 1
          fi
          chmod 600 "${HOME}/.ssh/known_hosts"
          ssh -i "${key_file}" -p "${VPS_PORT}" \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile="${HOME}/.ssh/known_hosts" \
            -o ConnectTimeout=15 \
            "${VPS_USER}@${VPS_HOST}" "echo [deploy-vps] ssh connectivity ok"

      - name: Upload repository snapshot to VPS (best-effort)
        id: snapshot_upload
        continue-on-error: true
        shell: bash
        env:
          VPS_HOST: ${{ steps.ssh_inputs.outputs.host }}
          VPS_PORT: ${{ steps.ssh_inputs.outputs.port }}
          VPS_USER: ${{ steps.ssh_inputs.outputs.user }}
        run: |
          set -euo pipefail
          key_file="${HOME}/.ssh/hlauto_deploy_key"
          ssh_opts=(
            -i "${key_file}"
            -p "${VPS_PORT}"
            -o BatchMode=yes
            -o StrictHostKeyChecking=yes
            -o UserKnownHostsFile="${HOME}/.ssh/known_hosts"
            -o ConnectTimeout=15
            -o ServerAliveInterval=15
            -o ServerAliveCountMax=3
          )
          remote_tmp="/tmp/hlauto_repo_snapshot_${GITHUB_RUN_ID}_${GITHUB_RUN_ATTEMPT}.tar.gz"
          tar --exclude=.git --exclude=.github --exclude=node_modules --exclude=.env.local --exclude=data -czf - . \
            | ssh "${ssh_opts[@]}" "${VPS_USER}@${VPS_HOST}" "cat > '${remote_tmp}'"
          echo "[deploy-vps] snapshot uploaded to ${remote_tmp}"

      - name: Deploy to VPS over SSH
        shell: bash
        env:
          VPS_HOST: ${{ steps.ssh_inputs.outputs.host }}
          VPS_PORT: ${{ steps.ssh_inputs.outputs.port }}
          VPS_USER: ${{ steps.ssh_inputs.outputs.user }}
          DEPLOY_REF: ${{ steps.ref.outputs.ref }}
        run: |
          set -euo pipefail
          key_file="${HOME}/.ssh/hlauto_deploy_key"
          ssh_opts=(
            -i "${key_file}"
            -p "${VPS_PORT}"
            -o BatchMode=yes
            -o StrictHostKeyChecking=yes
            -o UserKnownHostsFile="${HOME}/.ssh/known_hosts"
            -o ConnectTimeout=15
            -o ServerAliveInterval=15
            -o ServerAliveCountMax=3
          )
          if [[ ! "${DEPLOY_REF}" =~ ^[0-9A-Za-z._/-]{1,120}$ ]]; then
            echo "::error::Invalid deploy_ref format: ${DEPLOY_REF}"
            exit 1
          fi
          remote_cmd="$(cat <<EOF
          set -euo pipefail
          app_dir="/opt/hlauto/trade"
          snapshot_path="/tmp/hlauto_repo_snapshot_${GITHUB_RUN_ID}_${GITHUB_RUN_ATTEMPT}.tar.gz"
          use_snapshot=0
          if [[ -f "\${snapshot_path}" ]]; then
            if mkdir -p "\${app_dir}" && tar -xzf "\${snapshot_path}" -C "\${app_dir}"; then
              echo "[deploy-vps] snapshot apply success: \${snapshot_path}"
              use_snapshot=1
            else
              echo "[deploy-vps] WARN: snapshot apply failed, fallback to git sync"
            fi
            rm -f "\${snapshot_path}" || true
          else
            echo "[deploy-vps] snapshot not found, fallback to git sync"
          fi
          export HLAUTO_APP_DIR="/opt/hlauto/trade"
          export HLAUTO_APP_USER="${VPS_USER}"
          export HLAUTO_SERVICE_NAME="hlauto"
          export HLAUTO_SKIP_OPS_SANITY="1"
          export HLAUTO_DEPLOY_JOURNAL_STRICT_FAIL="0"
          export HLAUTO_SKIP_GIT_SYNC="\${use_snapshot}"
          export HLAUTO_DEPLOY_SHA="${DEPLOY_REF}"
          export HLAUTO_DEPLOY_SKIP_TESTS="1"
          export HLAUTO_DEPLOY_SKIP_SELFTEST="1"
          bash /opt/hlauto/trade/ops/scripts/deploy.sh "${DEPLOY_REF}"
          EOF
          )"
          diagnostic_cmd="$(cat <<'EOF'
          set -euo pipefail
          echo "[deploy-vps] ---- remote diagnostic start ----"
          sudo -n /bin/systemctl status hlauto --no-pager || true
          sudo -n /bin/journalctl --utc -u hlauto -n 200 --no-pager || true
          echo "[deploy-vps] ---- remote diagnostic end ----"
          EOF
          )"
          for attempt in 1 2 3; do
            echo "[deploy-vps] deploy attempt ${attempt}/3"
            if ssh "${ssh_opts[@]}" "${VPS_USER}@${VPS_HOST}" "${remote_cmd}"; then
              exit 0
            fi
            ssh "${ssh_opts[@]}" "${VPS_USER}@${VPS_HOST}" "${diagnostic_cmd}" || true
            if [[ "${attempt}" -lt 3 ]]; then
              sleep $((attempt * 15))
            fi
          done
          echo "::error::Deploy to VPS failed after 3 attempts"
          exit 1

      - name: Post-deploy quick check (10m, fail on invariant A/B)
        shell: bash
        env:
          VPS_HOST: ${{ steps.ssh_inputs.outputs.host }}
          VPS_PORT: ${{ steps.ssh_inputs.outputs.port }}
          VPS_USER: ${{ steps.ssh_inputs.outputs.user }}
        run: |
          set -euo pipefail
          key_file="${HOME}/.ssh/hlauto_deploy_key"
          ssh_opts=(
            -i "${key_file}"
            -p "${VPS_PORT}"
            -o BatchMode=yes
            -o StrictHostKeyChecking=yes
            -o UserKnownHostsFile="${HOME}/.ssh/known_hosts"
            -o ConnectTimeout=15
            -o ServerAliveInterval=15
            -o ServerAliveCountMax=3
          )
          remote_cmd="$(cat <<'EOF'
          set -euo pipefail
          export HLAUTO_APP_DIR="/opt/hlauto/trade"
          export HLAUTO_SERVICE_NAME="hlauto"
          export HLAUTO_SUMMARY_SERVICE_NAME="hlauto-daily-summary"
          bash /opt/hlauto/trade/ops/scripts/ops-sanity-check.sh --app-dir "${HLAUTO_APP_DIR}" --service "${HLAUTO_SERVICE_NAME}" --summary-service "${HLAUTO_SUMMARY_SERVICE_NAME}"
          bash /opt/hlauto/trade/ops/scripts/ops-report.sh --since "10 minutes ago" --service "${HLAUTO_SERVICE_NAME}" --summary-only
          report_json="$(bash /opt/hlauto/trade/ops/scripts/ops-report.sh --since "10 minutes ago" --service "${HLAUTO_SERVICE_NAME}" --json-only)"
          printf "%s\n" "${report_json}" >/tmp/hlauto_quick_report.json
          node /opt/hlauto/trade/ops/assert-invariants.mjs --input /tmp/hlauto_quick_report.json --require A,B
          EOF
          )"
          ssh "${ssh_opts[@]}" "${VPS_USER}@${VPS_HOST}" "${remote_cmd}"

      - name: Post-deploy ops report (24h summary, warn only)
        shell: bash
        env:
          VPS_HOST: ${{ steps.ssh_inputs.outputs.host }}
          VPS_PORT: ${{ steps.ssh_inputs.outputs.port }}
          VPS_USER: ${{ steps.ssh_inputs.outputs.user }}
        run: |
          set -euo pipefail
          key_file="${HOME}/.ssh/hlauto_deploy_key"
          ssh_opts=(
            -i "${key_file}"
            -p "${VPS_PORT}"
            -o BatchMode=yes
            -o StrictHostKeyChecking=yes
            -o UserKnownHostsFile="${HOME}/.ssh/known_hosts"
            -o ConnectTimeout=15
            -o ServerAliveInterval=15
            -o ServerAliveCountMax=3
          )
          remote_cmd="$(cat <<'EOF'
          set -euo pipefail
          export HLAUTO_APP_DIR="/opt/hlauto/trade"
          export HLAUTO_SERVICE_NAME="hlauto"
          bash /opt/hlauto/trade/ops/scripts/ops-report.sh --since "24 hours ago" --service "${HLAUTO_SERVICE_NAME}" --summary-only
          report_json="$(bash /opt/hlauto/trade/ops/scripts/ops-report.sh --since "24 hours ago" --service "${HLAUTO_SERVICE_NAME}" --json-only)"
          tmp_json="$(mktemp)"
          printf "%s\n" "${report_json}" > "${tmp_json}"
          node -e "const fs=require(\"node:fs\"); const data=JSON.parse(fs.readFileSync(process.argv[1], \"utf8\")); const a=String(data?.invariantStatus?.A || (data?.invariants?.A?.pass ? \"PASS\" : \"FAIL\")); const b=String(data?.invariantStatus?.B || (data?.invariants?.B?.pass ? \"PASS\" : \"FAIL\")); const c=String(data?.invariantStatus?.C || (data?.invariants?.C?.pass ? \"PASS\" : \"FAIL\")); if (a !== \"PASS\" || b !== \"PASS\" || c === \"FAIL\") { console.log(`[ops-report] WARN 24h invariants status A/B/C=${a}/${b}/${c}`); } else { console.log(`[ops-report] OK 24h invariants status A/B/C=${a}/${b}/${c}`); }" "${tmp_json}"
          rm -f "${tmp_json}"
          EOF
          )"
          ssh "${ssh_opts[@]}" "${VPS_USER}@${VPS_HOST}" "${remote_cmd}"
