name: deploy-vps
# Secrets contract:
# - VPS_USER must be "trader" (SSH key auth only)
# - VPS_FINGERPRINT is required for host key pinning

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_ref:
        description: "Branch, tag, or commit SHA to deploy (default: current SHA)"
        required: false
        default: ""

concurrency:
  group: deploy-vps
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Secret guard (.env.local)
        shell: bash
        run: |
          set -euo pipefail
          if git ls-files --error-unmatch .env.local >/dev/null 2>&1; then
            echo "::error::.env.local is tracked. Run: git rm --cached .env.local"
            exit 1
          fi
          test -f .env.local.example

      - name: Resolve deploy ref
        id: ref
        shell: bash
        run: |
          set -euo pipefail
          ref="${{ github.event.inputs.deploy_ref }}"
          if [[ -z "${ref}" ]]; then
            ref="${GITHUB_SHA}"
          fi
          echo "ref=${ref}" >> "${GITHUB_OUTPUT}"
          echo "Deploy ref: ${ref}"

      - name: Validate SSH deploy secrets
        id: ssh_inputs
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_FINGERPRINT: ${{ secrets.VPS_FINGERPRINT }}
        run: |
          set -euo pipefail
          missing=()
          [[ -n "${VPS_HOST:-}" ]] || missing+=("VPS_HOST")
          [[ -n "${VPS_PORT:-}" ]] || missing+=("VPS_PORT")
          [[ -n "${VPS_USER:-}" ]] || missing+=("VPS_USER")
          [[ -n "${VPS_SSH_KEY:-}" ]] || missing+=("VPS_SSH_KEY")
          [[ -n "${VPS_FINGERPRINT:-}" ]] || missing+=("VPS_FINGERPRINT")
          if ((${#missing[@]} > 0)); then
            echo "::error::Missing required GitHub Secrets: ${missing[*]}"
            exit 1
          fi

          host="$(printf '%s' "${VPS_HOST}" | tr -d '\r' | xargs)"
          port="$(printf '%s' "${VPS_PORT}" | tr -d '\r' | xargs)"
          user="$(printf '%s' "${VPS_USER}" | tr -d '\r' | xargs)"
          fp_raw="$(printf '%s' "${VPS_FINGERPRINT}" | tr -d '\r')"
          fp_trimmed="$(printf '%s' "${fp_raw}" | xargs)"
          fp=""

          if [[ "${fp_trimmed}" == ssh-* ]]; then
            tmp_key="$(mktemp)"
            printf '%s\n' "${fp_trimmed}" > "${tmp_key}"
            fp="$(ssh-keygen -lf "${tmp_key}" -E sha256 | awk '{print $2}')"
            rm -f "${tmp_key}"
          else
            fp="$(printf '%s\n' "${fp_trimmed}" | grep -oE 'SHA256:[A-Za-z0-9+/=]+' | head -n1)"
          fi

          if [[ -z "${fp}" ]]; then
            echo "::error::VPS_FINGERPRINT must contain SHA256:<base64> or a full SSH public key line."
            exit 1
          fi

          echo "host=${host}" >> "${GITHUB_OUTPUT}"
          echo "port=${port}" >> "${GITHUB_OUTPUT}"
          echo "user=${user}" >> "${GITHUB_OUTPUT}"
          echo "fingerprint=${fp}" >> "${GITHUB_OUTPUT}"

      - name: Preflight host key fingerprint
        shell: bash
        env:
          VPS_HOST: ${{ steps.ssh_inputs.outputs.host }}
          VPS_PORT: ${{ steps.ssh_inputs.outputs.port }}
          VPS_FINGERPRINT: ${{ steps.ssh_inputs.outputs.fingerprint }}
        run: |
          set -euo pipefail
          hostkeys="$(mktemp)"
          trap 'rm -f "${hostkeys}"' EXIT

          ssh-keyscan -p "${VPS_PORT}" -t ed25519,ecdsa,rsa "${VPS_HOST}" > "${hostkeys}" 2>/dev/null || true
          if [[ ! -s "${hostkeys}" ]]; then
            echo "::error::Unable to fetch SSH host keys via ssh-keyscan for ${VPS_HOST}:${VPS_PORT}"
            exit 1
          fi

          fingerprints="$(ssh-keygen -lf "${hostkeys}" -E sha256 | awk '{print $2}' | sort -u)"
          if ! printf '%s\n' "${fingerprints}" | grep -Fxq "${VPS_FINGERPRINT}"; then
            echo "::error::VPS_FINGERPRINT does not match host keys for ${VPS_HOST}:${VPS_PORT}"
            echo "Discovered fingerprints:"
            printf '%s\n' "${fingerprints}"
            exit 1
          fi

      - name: Deploy to VPS over SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ steps.ssh_inputs.outputs.host }}
          port: ${{ steps.ssh_inputs.outputs.port }}
          username: ${{ steps.ssh_inputs.outputs.user }}
          key: ${{ secrets.VPS_SSH_KEY }}
          fingerprint: ${{ steps.ssh_inputs.outputs.fingerprint }}
          command_timeout: 30m
          script: |
            export HLAUTO_APP_DIR="/opt/hlauto/trade"
            export HLAUTO_APP_USER="trader"
            export HLAUTO_SERVICE_NAME="hlauto"
            bash /opt/hlauto/trade/ops/scripts/deploy.sh "${{ steps.ref.outputs.ref }}"

      - name: Post-deploy ops report (24h summary)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ steps.ssh_inputs.outputs.host }}
          port: ${{ steps.ssh_inputs.outputs.port }}
          username: ${{ steps.ssh_inputs.outputs.user }}
          key: ${{ secrets.VPS_SSH_KEY }}
          fingerprint: ${{ steps.ssh_inputs.outputs.fingerprint }}
          command_timeout: 30m
          script: |
            export HLAUTO_APP_DIR="/opt/hlauto/trade"
            export HLAUTO_SERVICE_NAME="hlauto"
            bash /opt/hlauto/trade/ops/scripts/ops-report.sh --since "24 hours ago" --service "${HLAUTO_SERVICE_NAME}" --summary-only
